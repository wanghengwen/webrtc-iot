# webrtc-iot - é¢å‘ç‰©è”ç½‘/åµŒå…¥å¼è®¾å¤‡çš„ç°ä»£ C++ WebRTC åº“

![build](https://github.com/wanghengwen/webrtc-iot/actions/workflows/build.yml/badge.svg)

webrtc-iot æ˜¯ä¸€ä¸ªç”¨ C++ ç¼–å†™çš„ç°ä»£ WebRTC å®ç°ï¼Œä¸“ä¸ºç‰©è”ç½‘å’ŒåµŒå…¥å¼è®¾å¤‡æµåª’ä½“åº”ç”¨è€Œè®¾è®¡ã€‚è¯¥åº“ç»è¿‡å¤§é‡é‡æ„ï¼Œæä¾›äº†ç®€æ´çš„ C++ æ¥å£ï¼ŒåŒæ—¶ä¿æŒäº†åœ¨èµ„æºå—é™ç¯å¢ƒä¸­çš„æ€§èƒ½å’Œå¯ç§»æ¤æ€§ã€‚

> **è‡´è°¢**: æœ¬é¡¹ç›®åŸºäº @sepfy çš„ä¼˜ç§€é¡¹ç›® [libpeer](https://github.com/sepfy/libpeer)ã€‚æˆ‘ä»¬å¯¹æä¾›åŸºç¡€ WebRTC å®ç°çš„åŸä½œè€…è¡¨ç¤ºè¯šæŒšçš„æ„Ÿè°¢ï¼Œæ­£æ˜¯ä»–ä»¬çš„å·¥ä½œä½¿å¾—è¿™æ¬¡ C++ ç°ä»£åŒ–æ”¹é€ æˆä¸ºå¯èƒ½ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

### åª’ä½“æ”¯æŒ
- **è§†é¢‘ç¼–è§£ç å™¨**
  - H.264ï¼Œæ”¯æŒåˆ†ç‰‡ä¼ è¾“
  - å¯é…ç½®å¸§ç‡å’Œç ç‡
- **éŸ³é¢‘ç¼–è§£ç å™¨**  
  - G.711 PCM (A-law/Âµ-law)
  - OPUSï¼Œæ”¯æŒå¯é…ç½®ç ç‡
- **å®æ—¶å¤„ç†**
  - ä¼˜åŒ–çš„ RTP/RTCP å¤„ç†
  - åŠ¨æ€ SSRC ç”Ÿæˆ

### WebRTC æ ¸å¿ƒåŠŸèƒ½
- **ç«¯åˆ°ç«¯è¿æ¥**
  - ICE (äº¤äº’å¼è¿æ¥å»ºç«‹)
  - STUN/TURN æœåŠ¡å™¨æ”¯æŒ
  - IPv4/IPv6 åŒæ ˆ
- **å®‰å…¨æ€§**
  - DTLS-SRTP åŠ å¯†
  - è¯ä¹¦æŒ‡çº¹éªŒè¯
  - å®‰å…¨å¯†é’¥äº¤æ¢
- **æ•°æ®é€šé“**
  - åŸºäº SCTP çš„å¯é /ä¸å¯é æ¶ˆæ¯ä¼ è¾“
  - æ”¯æŒäºŒè¿›åˆ¶å’Œæ–‡æœ¬æ•°æ®
  - æ¯ä¸ªè¿æ¥æ”¯æŒå¤šä¸ªé€šé“

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç°ä»£ C++ è®¾è®¡
- **RAII** èµ„æºç®¡ç†
- **æ™ºèƒ½æŒ‡é’ˆ** ç¡®ä¿å†…å­˜å®‰å…¨
- **std::function** å›è°ƒå‡½æ•°ï¼Œçµæ´»çš„äº‹ä»¶å¤„ç†
- **å‘½åç©ºé—´ç»„ç»‡** (`rtc::` å‘½åç©ºé—´)
- **å¼‚å¸¸å®‰å…¨** æ“ä½œ

### é¡¹ç›®ç»“æ„
```
webrtc-iot/
â”œâ”€â”€ include/           # å…¬å…±å¤´æ–‡ä»¶ (C++ å’Œ C)
â”œâ”€â”€ src/              # å®ç°æ–‡ä»¶
â”œâ”€â”€ tests/            # æµ‹è¯•åº”ç”¨ç¨‹åº
â””â”€â”€ third_party/      # å¤–éƒ¨ä¾èµ–
```

### æ ¸å¿ƒç±»
- `rtc::PeerConnection` - WebRTC ç«¯åˆ°ç«¯è¿æ¥ä¸»ç±»
- `rtc::IceAgent` - ICE è¿æ¥ç®¡ç†  
- `rtc::RtpEncoder/RtpDecoder` - åª’ä½“å¤„ç†
- `rtc::DtlsSrtpSession` - å®‰å…¨å±‚
- `rtc::SctpAssociation` - æ•°æ®é€šé“æ”¯æŒ

## ğŸ“¦ ä¾èµ–åº“

| åº“ | ç”¨é€” | ç‰ˆæœ¬ |
|---------|---------|---------| 
| [mbedTLS](https://github.com/Mbed-TLS/mbedtls) | åŠ å¯†å’Œ TLS | æœ€æ–°ç‰ˆ |
| [libsrtp](https://github.com/cisco/libsrtp) | SRTP åŠ å¯† | v2.x |
| [usrsctp](https://github.com/sctplab/usrsctp) | æ•°æ®é€šé“ SCTP | æœ€æ–°ç‰ˆ |

æ‰€æœ‰ä¾èµ–åº“éƒ½é€šè¿‡ CMake è‡ªåŠ¨ä¸‹è½½å’Œæ„å»ºã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚
```bash
sudo apt update && sudo apt install -y git cmake build-essential
```

### æ„å»ºå’Œæµ‹è¯•
```bash
# å…‹éš†åŒ…å«æ‰€æœ‰å­æ¨¡å—çš„ä»“åº“
git clone --recursive https://github.com/wanghengwen/webrtc-iot
cd webrtc-iot

# æ„å»ºåº“å’Œæµ‹è¯•ç¨‹åº
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build -j$(nproc)

# è¿è¡ŒåŸºæœ¬è¿æ¥æµ‹è¯•
./build/tests/test_agent

# æµ‹è¯•éŸ³é¢‘å›å£°çš„ç«¯åˆ°ç«¯è¿æ¥
./build/tests/test_peer_offer
```

### åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹

```cpp
#include "peer_connection.hpp"

int main() {
    // é…ç½®ç«¯åˆ°ç«¯è¿æ¥
    rtc::PeerConfiguration config;
    config.audio_codec = rtc::MediaCodec::PCMU;
    
    // æ·»åŠ  STUN æœåŠ¡å™¨ç”¨äº NAT ç©¿é€
    config.ice_servers.push_back({
        .urls = "stun:stun.l.google.com:19302"
    });
    
    // åˆ›å»ºç«¯åˆ°ç«¯è¿æ¥
    rtc::PeerConnection pc(config);
    
    // è®¾ç½®å›è°ƒå‡½æ•°
    pc.on_ice_connection_state_change([](rtc::PeerConnectionState state) {
        std::cout << "è¿æ¥çŠ¶æ€: " << static_cast<int>(state) << std::endl;
    });
    
    // åˆ›å»ºå’Œå¤„ç† offer/answer
    std::string offer = pc.create_offer();
    std::cout << "æœ¬åœ° offer: " << offer << std::endl;
    
    return 0;
}
```

## ğŸ§ª æµ‹è¯•åº”ç”¨ç¨‹åº

é¡¹ç›®åŒ…å«å¤šä¸ªæ¼”ç¤ºä¸åŒåŠŸèƒ½çš„æµ‹è¯•åº”ç”¨ç¨‹åºï¼š

### æ ¸å¿ƒæµ‹è¯•
- **`test_agent`** - ICE ä»£ç†å’Œ STUN è¿æ¥æµ‹è¯•
- **`test_peer_offer`** - å®Œæ•´çš„ç«¯åˆ°ç«¯è¿æ¥å’ŒéŸ³é¢‘å›å£°æµ‹è¯•
- **`test_dtls`** - DTLS-SRTP å®‰å…¨å±‚æµ‹è¯•

### éŸ³é¢‘å›å£°æµ‹è¯•
`test_peer_offer` åº”ç”¨ç¨‹åºæ¼”ç¤ºäº†ï¼š
- éšæœº SSRC ç”Ÿæˆ
- éŸ³é¢‘æ•°æ®åŒ…ç”Ÿæˆå’ŒéªŒè¯
- å®æ—¶éŸ³é¢‘æµå’Œå›å£°éªŒè¯
- è¿æ¥çŠ¶æ€ç›‘æ§

```bash
# è¿è¡ŒéŸ³é¢‘å›å£°æµ‹è¯• (å‘é€ 1000 ä¸ªæ•°æ®åŒ…ï¼Œé—´éš” 20ms)
./build/tests/test_peer_offer
```

## ğŸ“± å¹³å°ç¤ºä¾‹

å¹³å°ç‰¹å®šçš„ç¤ºä¾‹ç›®å‰æ­£åœ¨æ›´æ–°ä»¥ä½¿ç”¨æ–°çš„ C++ æ¥å£ã€‚è¯·ç¨åæŸ¥çœ‹ï¼š
- **æ ‘è“æ´¾** - å®Œæ•´çš„è§†é¢‘å’ŒåŒå‘éŸ³é¢‘æµ
- **ESP32** - é€šè¿‡æ•°æ®é€šé“è¿›è¡Œ MJPEG æµä¼ è¾“  
- **æ ‘è“æ´¾ Pico** - è½»é‡çº§æ•°æ®é€šé“æ¶ˆæ¯ä¼ é€’

ç›®å‰è¯·å‚è€ƒ `tests/` ç›®å½•ä¸­çš„æµ‹è¯•åº”ç”¨ç¨‹åºäº†è§£ä½¿ç”¨ç¤ºä¾‹ã€‚

## ğŸ”§ é…ç½®é€‰é¡¹

### æ„å»ºé€‰é¡¹
```bash
# å¸¦è¯¦ç»†æ—¥å¿—çš„è°ƒè¯•æ„å»º
cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug

# é’ˆå¯¹å¤§å°ä¼˜åŒ–çš„å‘å¸ƒæ„å»º
cmake -S . -B build -DCMAKE_BUILD_TYPE=MinSizeRel

# ç¦ç”¨æ•°æ®é€šé“æ”¯æŒ
cmake -S . -B build -DCONFIG_ENABLE_DATACHANNEL=OFF
```

### è¿è¡Œæ—¶é…ç½®
`include/config.h` ä¸­çš„å…³é”®é…ç½®é€‰é¡¹ï¼š
- `CONFIG_MTU` - æœ€å¤§ä¼ è¾“å•å…ƒ (é»˜è®¤: 1500)
- `CONFIG_KEEPALIVE_TIMEOUT` - è¿æ¥è¶…æ—¶ (é»˜è®¤: 10000ms)
- `CONFIG_ENABLE_DATACHANNEL` - æ•°æ®é€šé“æ”¯æŒå¼€å…³

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **DTLS 1.2** åª’ä½“æµåŠ å¯†
- **SRTP** å®æ—¶åª’ä½“ä¿æŠ¤  
- **è¯ä¹¦æŒ‡çº¹éªŒè¯** å¯¹ç­‰ç«¯éªŒè¯
- **å®‰å…¨éšæœº** SSRC ç”Ÿæˆ
- **å†…å­˜å®‰å…¨** C++ å®ç°

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ï¼è¯·ç¡®ä¿ï¼š
1. ä»£ç éµå¾ªç°æœ‰çš„ C++ é£æ ¼
2. æ–°åŠŸèƒ½åŒ…å«é€‚å½“çš„æµ‹è¯•
3. ä¸º API æ›´æ”¹æ›´æ–°æ–‡æ¡£
4. æäº¤ PR å‰æ‰€æœ‰æµ‹è¯•é€šè¿‡

## ğŸ™ è‡´è°¢

æœ¬é¡¹ç›®åŸºäºç”± @sepfy åˆ›å»ºçš„ä¼˜ç§€ [libpeer](https://github.com/sepfy/libpeer) é¡¹ç›®ã€‚åŸå§‹ libpeer æä¾›äº†ï¼š

- åŸºäº C å®ç°çš„ç¨³å›º WebRTC åŸºç¡€
- å…¨é¢çš„å¹³å°æ”¯æŒ (ESP32ã€æ ‘è“æ´¾ã€Pico)
- ç²¾å¿ƒè®¾è®¡çš„ç½‘ç»œå’Œåª’ä½“å¤„ç†æ¶æ„
- å…¨é¢çš„æµ‹è¯•æ¡†æ¶å’Œç¤ºä¾‹

æˆ‘ä»¬çš„ç°ä»£åŒ–å·¥ä½œé‡ç‚¹æ˜¯ï¼š
- é‡æ„ä¸ºç°ä»£ C++ (C++17)
- é€šè¿‡ RAII å’Œæ™ºèƒ½æŒ‡é’ˆæé«˜å†…å­˜å®‰å…¨
- ä½¿ç”¨ç”¨æˆ·ç®¡ç†çš„ä¿¡ä»¤ç®€åŒ– API
- é’ˆå¯¹åµŒå…¥å¼åº”ç”¨ä¼˜åŒ–æ€§èƒ½

æˆ‘ä»¬æ·±æ·±æ„Ÿè°¢åŸå§‹è´¡çŒ®è€…çš„å‡ºè‰²å·¥ä½œï¼Œæ­£æ˜¯ä»–ä»¬è®©è¿™ä¸ªé¡¹ç›®æˆä¸ºå¯èƒ½ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®æŒ‰ç…§ LICENSE æ–‡ä»¶ä¸­æŒ‡å®šçš„æ¡æ¬¾è¿›è¡Œè®¸å¯ã€‚

## ğŸ†˜ æ”¯æŒ

- **é—®é¢˜åé¦ˆ**: [GitHub Issues](https://github.com/wanghengwen/webrtc-iot/issues)
- **æ–‡æ¡£**: å‚è§å†…è”ä»£ç æ³¨é‡Šå’Œæµ‹è¯•åº”ç”¨ç¨‹åº
- **ç¤ºä¾‹**: `tests/` ç›®å½•ä¸­çš„æµ‹è¯•åº”ç”¨ç¨‹åºæ¼”ç¤ºäº†åº“çš„ä½¿ç”¨æ–¹æ³•

---